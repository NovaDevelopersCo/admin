name: Admin-DEPLOY

on: 
    push:
        branches: ["main"]

env: 
    LOGIN: ${{secrets.DOCKER_LOGIN}}
    PASSWORD: ${{secrets.DOCKER_PASSWORD}}
    SERVER_NAME: ${{secrets.DOCKER_SERVER_NAME}}
    VITE_SIMPLE_REST_URL: ${{secrets.VITE_SIMPLE_REST_URL}}
    SSH_KEY: ${{secrets.SSH_KEY}}
    SSH_USERNAME: ${{secrets.SSH_USERNAME}}
    SSH_HOST: ${{secrets.SSH_HOST}}

jobs:
    server_build: 
        runs-on: ubuntu-latest
        defaults:
            run:
                working-directory: server
        steps:
            - uses: actions/checkout@master
            - name: login to docker
              run: |
                docker login -u ${{env.LOGIN}} -p ${{env.PASSWORD}}
            - name: build image
              run: docker build -t ${{env.LOGIN}}/${{env.SERVER_NAME}}:deploy -f Dockerfile .
            - name: push build
              run: docker push ${{env.LOGIN}}/${{env.SERVER_NAME}}:deploy
    
    deploy:
        runs-on: ubuntu-latest
        needs: server_build
        defaults:
          run:
            working-directory: client
        steps:
            - uses: actions/checkout@master
            - name: install dependencies
              run: npm i
            - name: build
              run: npm run build
              env: 
                VITE_SIMPLE_REST_URL: ${{env.VITE_SIMPLE_REST_URL}}
            - name: ssh connection
              uses: appleboy/ssh-action@v1.0.3
              with:
                host: ${{env.SSH_HOST}}
                username: ${{env.SSH_USERNAME}}
                key: ${{env.SSH_KEY}}
                script: whoami

            